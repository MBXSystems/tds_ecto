dependencies:
  pre:
    - if ! asdf | grep version; then git clone https://github.com/HashNuke/asdf.git ~/.asdf; fi
    - ~/.asdf/bin/asdf plugin-add erlang https://github.com/HashNuke/asdf-erlang.git
    - ~/.asdf/bin/asdf plugin-add elixir https://github.com/HashNuke/asdf-elixir.git
    - erlang_version=$(awk '/erlang/ { print $2 }' .tool-versions) && asdf install erlang ${erlang_version}
    - elixir_version=$(awk '/elixir/ { print $2 }' .tool-versions) && asdf install elixir ${elixir_version}
    - mix local.hex --force
    - mix local.rebar --force
    - mix deps.get
    - mix deps.compile
    - curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
    - curl https://packages.microsoft.com/config/ubuntu/16.04/prod.list | sudo tee /etc/apt/sources.list.d/msprod.list
    - sudo apt-get update
    - sudo apt-get install mssql-tools unixodbc-dev
    - echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
    - source ~/.bashrc 
    - docker run -e 'ACCEPT_EULA=Y' -e 'SA_PASSWORD=Som320923!!!2932#ePassword2938474' -p 1433:1433 -d microsoft/mssql-server-linux
    - sqlcmd -S localhost -U SA -P Som320923!!!2932#ePassword2938474 -Q "CREATE LOGIN mssql WITH PASSWORD = 'mssql'; CREATE USER mssql FOR LOGIN mssql; sp_addsrvrolemember 'mssql', 'sysadmin'"
  cache_directories:
    - ~/.asdf
    - ~/.mix
    - deps
    - _build
general:
  branches:
    only:
      - ecto2
test:
  override:
    - mix test